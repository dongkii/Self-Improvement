# 08. Index

- 인덱스는 테이버베이스 쿼리의 성능을 언급하면서 빼놓을 수 없는 부분
- 각 인덱스의 특성과 차이는 상당히 중요하며, 물리 수준의 모델링을 할 때도 중요한 요소가 될 것이다.
- 인덱스는 쿼리 튜닝의 기본이 된다.

<br/>

## **목차**
- [8.5.1 인덱스 알고리즘](#1)
- [8.5.2 전문 검색 인덱스의 가용성](#2)

<br/>

# **`8.5 전문 검색 인덱스`**
문서의 내용 전체를 인덱스화해서 특정 키워드가 포함된 문서를 검색하는 전문(Full Text) 검색에는 InnoDB나 MyISAM 스토리지 엔진에서 제공하는 일반적인 용도의 B-Tree 인덱스를 사용할 수 없다. 문서 전체에 대한 분석과 검색을 위한 이러한 인덱싱 알고리즘을 전문 검색(Full Text search) 인덱스라고 하는데, 전문 검색 인덱스는 일반화된 기능의 명칭이지 전문 검색 알고리즘의 이름을 지칭하는 것은 아니다.

또한 MySQL 8.0 버전부터는 InnoDB가 기본 스토리지 엔진이 됐으며 모든 기능이 InnoDB 스토리지 엔진 중심으로 개선되고 있다.

<br/>

## **`8.5.1 인덱스 알고리즘`**<a id="1"></a>
전문 검색에서는 문서 본문의 내용에서 사용자가 검색하게 될 키워드를 분석해 내고, 빠른 검색용으로 사용할 수 있게 이러한 키워드로 인덱스를 구축한다.

전문 검색 인덱스는 문서의 키워드를 인덱싱하는 기법에 따라 크게 단어의 `어근 분석`과 n-gram 분석 알고리즘으로 구분할 수 있다. MySQL 8.0 버전부터는 구분자 방식은 이미 어근 분석과 n-gram 알고리즘에 함께 포함된다.

### **`어근 분석 알고리즘`**
MySQL 서버의 전문 검색 인덱스는 다음과 같은 두 가지 중요한 과정을 거쳐서 색인 작업이 수행된다.
- 불용어(Stop word) 처리
    - `검색에서 별 가치가 없는 단어를 모두 필터링해서 제거하는 작업을 의미한다.`
    - 불용어의 개수는 많지 않기 때문에 알고리즘을 구현한 코드에 모두 상수로 정의해서 사용하는 경우가 많다.
    - 유연성을 위해 불용어 자체를 데이터베이스화해서 사용자가 추가하거나 삭제할 수 있게 구현하는 경우도 있다.
    - 현재 MySQL 서버는 불용어가 소스코드에 정의돼 있지만, 별도로 정의하여 사용 가능하다.
- 어근 분석(Stemming)
    - `검색어로 선정된 단어의 뿌리인 원형을 찾는 작업이다.`
    - MySQL 서버에서는 오픈소스 형태소 분석 라이브러리인 MeCab을 플러그인 형태로 사용할 수 있게 지원한다.

<br/>

### **`n-gram 알고리즘`**
형태소 분석이 문장을 이해하는 알고리즘이라면, n-gram은 단순히 `키워드를 검색해내기 위한 인덱싱 알고리즘`이라고 할 수 있다.

n-gram이란 본문을 무조건 몇 글자씩 잘라서 인덱싱하는 방법이다. 형태소 분석보다는 알고리즘이 단순하고 국가별 언어에 대한 이해와 준비 작업이 필요 없는 반면, 만들어진 인덱스의 크기는 상당히 큰편이다.  
n-gram에서 n은 인덱싱할 키워드의 최소 글자 수를 의미하는데, 일반적으로 2글자 단위로 키워드를 쪼개서 인덱싱하는 2-gram(또는 Bi-gram) 방식이 많이 사용된다.

```
To be or not to be. That is the question
```

각 단어는 위와 같이 띄어쓰기(공백)와 마침표(.)를 기준으로 10개의 단어로 구분되고, 2글자씩 중첩해서 토큰으로 분리된다. 주의해야 할 것은 각 글자가 중첩해서 2글자씩 토큰으로 구분됐다는 것이다.  
10글자 단어라면 그 단어는 2-gram 알고리즘에서는 (10-1)개의 토큰으로 구분된다. 이렇게 구분된 각 토큰을 인덱스에 저장하기만 하면 된다. 이때 중복된 토큰은 하나의 인덱스 엔트리로 병합되어 저장된다.

MySQL 서버에 저장된 불용어
- information_schema.innodb_ft_default_stopword 테이블을 통해 확인 가능

```SQL
mysql> SELECT * FROM information_schema.INNODB_FT_DEFAULT_STOPWORD;

/*
VALUE
-----
a
about
an
...
*/
```

<br/>

### **`불용어 변경 및 삭제`**
n-gram의 토큰 파싱 및 불용어 처리에서 "ti", "at", "ha" 같은 토큰들은 "a"와 "i" 철자가 불용어로 등록돼 있기 때문에 모두 걸러져서 버려졌는데, 실제로 이 같은 불용어 처리는 사용자에게 도움이 되기보다는 사용자를 더 혼란스럽게 하는 기능일 수도 있다.

그래서 불용어 처리 자체를 완전히 무시하거나 MySQL 서버에 내장된 불용어 대신 사용자가 직접 불용어를 등록하는 방법을 권장한다.

<br/>

### **`전문 검색 인덱스의 불용어 처리 무시`**
불용어 처리를 무시하는 두 가지 방법
1. 첫 번째 방법
    - 스토리지 엔진에 관계없이 MySQL 서버의 모든 전문 검색 인덱스에 대해 불용어를 완전히 제거하는 것
    - 이를 위해서는 MySQL 서버의 설정파일(my.cnf)의 ft_stopword_file 시스템 변수에 빈 문자열을 설정하면 된다.
    - ft_stopword_file 시스템 변수는 MySQL 서버가 시작될 때만 인지하므로 서버 재시작이 필요하다.
2. 두 번째 방법
    - InnoDB 스토리지 엔진을 사용하는 테이블의 전문 검색 인덱스에 대해서만 불용어 처리를 무시할 수 있다.
    - InnoDB 테이블의 전문 검색 인덱스의 불용어 처리를 무시하려면 innodb_ft_enable_stopword 시스템 변수를 OFF로 설정하면 된다.
    - ```SQL
        SET GLOBAL innodb_ft_enable_stopword=OFF;
        ```

### **`사용자 정의 불용어 사용`**
사용자가 직접 정의한 불용어를 사용하는 두가지 방법
1. 첫 번째 방법
    - 불용어 목록을 파일로 저장하고, MySQL 서버 설정 파일에서 파일의 경로를 다음과 같이 ft_stopword_file 설정에 등록하면 된다.

    ```
    ft_stopword_file='/data/my_custom_stopword.txt'
    ```

2. 두 번째 방법
    - 불용어의 목록을 테이블로 저장해 사용
    - innodb_ft_server_stopword_table 시스템 변수에 불용어 테이블을 설정하면 된다.

<br/>

## **`8.5.2 전문 검색 인덱스의 가용성`**<a id="2"></a>
전문 검색 인덱스를 사용하려면 반드시 다음 두 가지 조건을 갖춰야 한다.
- 쿼리 문장이 전문 검색을 위한 문법(MATCH ... AGAINST ...)을 사용
- 테이블이 전문 검색 대상 칼럼에 대해서 전문 인덱스 보유

