# 08. Index

- 인덱스는 테이버베이스 쿼리의 성능을 언급하면서 빼놓을 수 없는 부분
- 각 인덱스의 특성과 차이는 상당히 중요하며, 물리 수준의 모델링을 할 때도 중요한 요소가 될 것이다.
- 인덱스는 쿼리 튜닝의 기본이 된다.

<br/>

## **목차**
- [8.4.1 구조 및 특성](#1)
- [8.4.2 R-Tree 인덱스의 용도](#2)

<br/>

# **`8.4 R-Tree 인덱스`**
공간인덱스(Spatial Index)는 R-Tree 인덱스 알고리즘을 이용해 2차원의 데이터를 인덱싱하고 검색하는 목적의 인덱스이다.  
기본적인 내부 매커니즘은 B-Tree와 흡사하다.  
`B-Tree`는 인덱스를 구성하는 칼럼의 값이 1차원의 스칼라 값인 반면, `R-Tree 인덱스`는 2차원의 공간 개념 값이라는 것이다.

MySQL의 공간 확장에 포함된 세 가지 기능
- 공간 데이터를 저장할 수 있는 데이터 타입
- 공간 데이터의 검색을 위한 공간 인덱스(R-Tree 알고리즘)
- 공간 데이터의 연산 함수(거리 또는 포함 관꼐의 처리)

<br/>

## **`8.4.1 구조 및 특성`**<a id="1"></a>
MySQL은 공간 정보의 저장 및 검색을 위해 여러 가지 기하학적 도형(Geometry) 정보를 관리할 수 있는 데이터 타입을 제공한다.
- POINT
- LINE
- POLYGON
- GEOMETRY

GEOMETRY 타입은 나머지 3개 타입의 슈퍼 타입으로, POINT와 LINE, POLYGON 객체를 모두 저장할 수 있다.

R-Tree는 MBR형태의 사각형들의 포함 관계를 B-Tree 형태로 구현한 인덱스이다.
- `MBR` : "Minimum Bounding Rectangle"의 약자로 해당 도형을 감싸는 최소 크기의 사각형을 의미

도형이 겹쳐있을 경우 제일 바깥쪽 MBR이 최상위 레벨이다.  
최상위 MBR은 R-Tree의 루트 노드에 저장되는 정보이며, 차상위 그룹 MBR은 R-Tree의 브랜치노드가 된다.   
마지막으로 각 도형의 객체는 리프 노드에 저장된다.

<br/>

## **`8.4.2 R-Tree 인덱스의 용도`**<a id="2"></a>
MBR 정보를 이용해 B-Tree 형태로 인덱스를 구축하므로 Rectangle의 'R'과 B-Tree의 'Tree'를 섞어 R-Tree라는 이름이 붙여졌으며, 공간(Spatial) 인덱스라고도 한다.  
일반적으로 WGS84(GPS) 기준의 위도, 경도 좌표에 주로 사용되며, CAD/CAM 소프트웨어 또는 회로 디자인 등과 같은 좌표시스템 기반을 둔 정보에 대해서는 모두 적용할 수 있다.

MySQL의 거리를 비교한느 ST_Distance()와 ST_Distance_Sphere() 함수는 공간 인덱스를 효율적으로 사용하지 못하기 때문에 공간 인덱스를 사용할 수 있는 ST_Contains() 또는 ST_Within()을 이용해 거리 기반의 검색을 해야한다.

```SQL
-- // ST_Contains() 또는 ST_Within()을 이용해 "사각 상자"에 포함된 좌표 Px만을 검색

mysql> SELECT * FROM tb_location
        WHERE ST_Contains(사각 상자, px);

mysql> SELECT * FROM tb_location
        WHERE ST_Within(px, 사각 상자);
```

ST_Contains() 함수와 ST_Within() 함수는 거의 동일한 비교를 수행하지만 두 함수의 파라미터는 반대로 사용해야 한다.
- ST_Contains() 함수는 첫 번째 파라미터로 포함 경계를 가진 도형을 명시하고 두 번째 파라미터로 포함되는 도형(또는 점 좌표)을 명시해야한다.
- ST_Within() 함수는 첫 번째 파라미터로 포함되는 도형(또는 점 좌표)을 명시하고 두 번째 파라미터로 포함 경계를 가진 도형을 명시해야 한다.