# 04. Architecture

# **`4.4 MySQL 로그 파일`**

<br/>

## **목차**
- [4.4.1 에러 로그 파일](#1)
- [4.4.2 제너럴 쿼리 로그 파일(제너럴 로그 파일, General log)](#2)
- [4.4.3 슬로우 쿼리 로그](#3)

<br/>

> ## **`4.4.1 에러 로그 파일`**<a id="1"></a>
MySQL이 실행되는 도중에 발생하는 에러나 경고 메시지가 출력되는 로그파일이다.  
파일의 위치는 MySQL 설정 파일(my.cnf)에서 log_error라는 이름의 파라미터로 정의된 경로에 생성된다.  
MySQL 설정 파일에 별도로 정의되지 않은 경우에는 데이터 디렉터리(datafir 파라미터에 설정된 디렉터리)에 .err라는 확장자가 붙은 팡리로 생성된다.

### `MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지`
- MySQL 서버가 정상적으로 기동했고('mysqld: ready for connections' 메시지 확인), 새로 변경하거나 추가한 파라미터에 대한 특별한 에러나 경고성 메시지가 없다면 정상적으로 적용된 것
- 특정 변수가 무시(ignore)된 경우에는 MySQL 서버는 정상적으로 기동하지만 해당 파라미터는 MySQL에 적용되지 못했음을 의미

### `마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지`

- InnoDB의 경우 MySQL 서버가 비정상적 또는 강제적으로 종료됐다면 다시 시작되면서 완료되지 못한 트랜잭션을 정리하고 디스크에 기록되지 못한 데이터가 있다면 다시 기록하는 재처리작업을 하게 된다.

- 간혹 문제가 있어서 복구되지 못할 때는 해당 에러 메시지를 출력하고 MySQL은 다시 종료된다.  
일반적으로 이 단계에서는 발생하는 문제는 상대적으로 해결하기가 어려운 문제점일 때가 많고, 때로는 innodb_force_recovery 파라미터를 0보다 큰 값으로 설정해야 MySQL이 시작될 수 있다.

### `쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지`
- 사전 예방이 어렵고, 주기적인 에러 로그파일 검토과정에서 발견된다.
- 숨겨진 문제점을 해결하기 위해선 자주 에러 로그 파일을 검토해야 한다.

### `비정상적으로 종료된 커넥션 메시지(Aborted connection)`
- 애플리케이션에서 정상적으로 접속 종료를 하지 못하고 프로그램이 종료된 경우
- 네트워크 문제로 인한 의도하지 않게 접속이 끊어지는 경우
- 이 메시지가 많이 기록되면 커넥션 종료 로직을 검토해봐야 한다.
- max_connect_errors 시스템 변숫값이 너무 낮게 설정된 경우 클라이언트 프로그램이 MySQL 서버에 접속하지 못하고 "Host 'host_name' is blocked" 라는 에러가 발생할 수 있다.

### `InnoDB의 모니터링 또는 상태 조회 명령(SHOW ENGINE INNODB STATUS 같은)의 결과 메시지`
- InnoDB의 테이블 모니터링이나 락 모니터링, 또는 InnoDB의 엔진 상태를 조회하는 명령은 상대적으로 큰 메시지를 로그파일에 기록한다.
- 모니터링을 사용한 이후에는 비활성화 시켜 에러 로그 파일이 커지지 않게 만들어야 한다.

### `MySQL의 종료 메시지`
- 아무도 모르게 종료되거나 재시작 될 경우 종료되며 출력한 메시지를 확인하는 것이 원인을 알 수 있는 유일한 방법이다.
- 누군가가 종료했다면 에러 로그 파일에서 'Received SHUTDOWN from user ...' 이라는 메시지를 확인할 수 있다.
- 종료 메시지가 없거나 스택 트레이스(대표적으로 16진수의 주솟값이 잔뜩 출력되는)와 같은 내용이 출력될 경우 MySQL 서버가 세그먼테이션 폴트(Segmentation fault)로 비정상적으로 종료된 것이라 판단할 수 있다.
- 스택 트레이스의 내용을 참조해 버그와 관련이 있는지 확인 후 버전 업그레이드 또는 회피책(WorkAround)을 찾는 것이 최적의 방법이다.

<br/>

> ## **`4.4.2 제너럴 쿼리 로그 파일(제너럴 로그 파일, General log)`**<a id="2"></a>
MySQL 서버에서 실행되는 쿼리로 어떤 것들이 있는지 전체 목록을 뽑아서 검토해 볼 때에는 쿼리 로그를 활성화해서 쿼리 로그 파일로 기록하게 한 후 파일을 검토하면 된다.  
쿼리 로그 파일에는 시간 단위로 실행됐던 쿼리의 내용이 모두 기록된다.

제너럴 쿼리 로그는 실행되기 전에 MySQL이 쿼리요청을 받으면 바로 기록하기 때문에 쿼리 실행 중 에러가 발생해도 일단 로그 파일에 기록된다.

쿼리 로그 파일의 경로는 general_log_file 이라는 이름의 파라미터에 설정되어 있다. 또한 쿼리 로그를 파일이 아닌 테이블에 저장되도록 설정할 수 있으므로 이 경우에는 파일이 아닌 테이블을 SQL로 조회해서 검토해야한다.
```SQL
mysql> SHOW GLOBAL VARIABLES LIKE 'general_log_file';
```

쿼리 로그를 파일로 저장할지 테이블로 저장할지는 log_output 파라미터로 결정된다.

<br/>

> ## **`4.4.3 슬로우 쿼리 로그`**<a id="3"></a>
MySQL 서버의 쿼리 튜닝은 크게 서비스가 적용되기 전에 전체적으로 튜닝하는 경우와 서비스 운영중에 MySQL 서버의 전체적인 성능 저하를 검사하거나 정기적인 점검을 위한 튜닝으로 나눌 수 있다.

슬로우 쿼리 로그 파일에 기록되는 쿼리는 일단 `정상적으로 실행이 완료됐고 실행하는 데 걸린 시간이 long_query_time에 정의된 시간보다 많이 걸린 쿼리`이다.

log_output 옵션을 이용해 파일 혹은 테이블로 기록 할 수 있다.
log_output 옵션을 TABLE로 하면 슬로우 쿼리 로그를 mysql DB의 테이블(general_log와 slow_log 테이블)에 저장하며, FILE로 설정하면 디스크의 파일로 저장한다.
slow_log 테이블과 general_log 테이블은 CSV 스토리지 엔진을 사용하기 때문에 결국 CSV파일로 저장하는 것과 동일하다.

MySQL 의 잠금처리는 MySQL 엔진레벨과 스토리지 엔진 레벨의 두 가지 레이어로 처리되는데, MyISAM이나 MEMORY 스토리지 엔진과 같은 경우에도 별도의 스토리지 엔진 레벨의 잠금을 가지지 않지만 InnoDB의 경우 MySQL 엔진 레벨의 잠금과 스토리지 엔진 자체 잠금을 가지고 있다.

슬로우 쿼리가 파일이나 테이블로 기록되도 내용은 동일하다.
- Time : 쿼리가 시작된 시간이 아닌 종료된 시점을 의미한다. 시작된 시간을 알기 위해선 'Query_time'을 빼야한다.
- User@Host : 쿼리를 실행한 사용자의 계정
- Query_time : 쿼리가 실행되는 데 걸린 전체 시간이다. Lock_time은 잠금에 대한 대기 시간만 표현한다. Lock_time이 매우 작은 값일 경우 무시해도 된다.
- Rows_examined : 쿼리가 처리되기 위해 몇 건의 레코드에 접근했는지를 의미하며, 'Rows_sent'는 실제 몇 건의 처리 결과를 클라이언트로 보냈는지를 의미한다.

MyISAM이나 MEMORY 스토리지 엔진에서는 테이블 단위의 잠금을 사용하고 MVCC와 같은 메커니즘이 없기 때문에 SELECT 쿼리라고 하더라도 Lock_time이 1초 이상 소요될 수 있다.  
InnoDB 테이블에 대한 SELECT도 상대적으로 큰 Lock_time이 걸릴 수 있는데 이는 레코드 수준이 아닌 MySQL 엔진 레벨에서 설정한 테이블 잠금 때문일 가능성이 크다.

슬로우 쿼리 또는 제너럴 로그 파일의 내용은 상당히 많아 Percona에서 개발한 Percona Toolkit의 pt-query-digest 스크립트를 이용하면 쉽게 빈도나 처리 성능별로 쿼리를 정렬해서 살펴 볼 수 있다.

