# 05. Transaction and Lock

- `잠금(Lock)`와 `트랜잭션`은 서로 비슷한 개념 같지만 `잠금은 동시성을 제어하기 위한 기능`이고 `트랜잭션은 데이터의 정합성을 보장하기 위한 기능`이다.  
- `격리 수준`은 하나의 트랜잭션 내에서 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고 차단할 것인지 결정하는 레벨

# **`5.2 MySQL 엔진의 잠금`**
MySQL에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 MySQL 엔진 레벨로 나눌 수 있다.  
MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, `스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향을 미치지는 않는다.`

<br/>

## **목차**
- [5.2.1 글로벌 락](#1)
- [5.2.2 테이블 락](#2)
- [5.2.3 네임드 락](#3)
- [5.2.4 메타데이터 락](#4)

<br/>

## **`5.2.1 글로벌 락`**<a id="1"></a>
- FLUSH TABLES WITH READ LOCK 명령으로 획득 가능
- 다른 세션에서 SELECT를 제외한 대부분의 DDL 문장이나 DML 문장을 실행하는 경우 글로벌 락이 해제될 때까지 해당 문장이 대기 상태로 남음
- 실행과 동시에 MySQL 서버에 존재하는 모든 테이블을 닫고 잠금을 검
- mysqldump같은 백업 프로그램이 우리가 알지 못하는 사이에 이 명령을 내부적으로 실행하고 백업할 때도 있음
- InnoDB 스토리지 엔진은 트랜잭션을 지원하기 때문에 일관된 데이터 상태를 위해 모든 데이터 변경 작업을 멈출 필요는 없음
- MySQL 8.0 부터는 백업 락이 도입됨
    - **백업 락은 일반적인 테이블의 데이터 변경은 허용**
    - XtraBackup이나 Enterprise Backup 툴이 실행되는 도중 DDL 명령어로 인해 백업이 실패할 수 있어 백업락이 도입 됨
<br/>

## **`5.2.2 테이블 락`**<a id="2"></a>
- 개별 테이블 단위로 설정되는 잠금
- 명시적 - 특별한 상황이 아니면 사용할 필요가 없다. - 온라인 작업에 상당한 영향을 미치기 때문
    - **LOCK TABLES table_name [READ|WRITE](테이블 잠금)**
    - **UNLOCK TABLES (잠금해제)**

- 묵시적
    - InnoDB 스토리지 엔진에서는 다른 MyISAM이나 MEMORY 테이블과 다르게 스토리지 엔진 차원에서 레코드 기반의 잠금을 제공하기 때문에 단순 데이터 변경 쿼리로 인해 묵시적인 테이블 락이 설정되지는 않음
    - InnoDB 테이블에도 테이블락이 설정되지만 대부분의 DML 쿼리에서는 무시되고 DDL 쿼리의 경우에만 영향을 미침

<br/>

## **`5.2.3 네임드 락`**<a id="3"></a>
- GET_LOCK() 함수를 이용해 임의의 문자열에 대해 잠금을 설정할 수 있음
- 단순히 사용자가 지정한 문자열에 대해 획득하고 반납하는 잠금
- 많은 레코드에 대해서 복잡한 요건으로 레코드를 변경하는 트랜잭션에 유용하게 사용될 수 있음
- 배치 프로그램처럼 한번에 많은 레코드를 변경하는 쿼리는 자주 데드락의 원인이 되는데, 이를 동일 데이터를 변경하거나 참조하는 프로그램끼리 분류해 네임드 락을 걸어 해결할 수 있음
- MySQL 8.0 버전부터는 네임드락을 중첩해서 사용 가능, 네임드 락을 한번에 모두 해제하는 기능도 추가됨

<br/>

## **`5.2.4 메타데이터 락`**<a id="4"></a>
- 데이터베이스 객체(테이블이나 뷰)의 이름이나 구조를 변경하는 경우 자동으로 획득하는 잠금
- RENAME TABLE a to b